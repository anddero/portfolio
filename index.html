<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio</title>

    <!-- CSS Section -->
    <style>
    </style>
</head>

<body>

<!-- Header Section -->
<header>
</header>

<!-- Main Content Section -->
<main>

    <input type="file" id="importLogInput" name="Import">
    <p id="importLogInputErrorMsg" style="color: red;"></p>

    <h2>Log</h2>
    <table id="logTable">
    </table>

    <button id="exportLogButton">Export</button>

</main>

<!-- JavaScript Section -->
<script>
    // Event bindings
    document.getElementById('importLogInput').addEventListener('change', onImportLogInputChange);
    document.getElementById('exportLogButton').addEventListener('click', onExportLogButtonClick);

    // Single source of truth across the app for underlying activity data
    let gActivityList = [];

    // Functions Section

    function setImportLogInputErrorMsg(message) {
        document.getElementById("importLogInputErrorMsg").innerText = message;
    }

    // Omit "async" as we must explicitly return "Promise" here anyway due to FileReader, which is not promise-based. Function still await-able.
    function readJsonFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();

            reader.onload = function (e) {
                try {
                    const parsedData = JSON.parse(e.target.result);
                    resolve(parsedData);
                } catch (error) {
                    reject(error);
                }
            };

            reader.onerror = () => reject(new Error("Failed to read file."));

            reader.readAsText(file);
        });
    }

    async function onImportLogInputChange(event) {
        console.log("onImportLogInputChange");

        const file = event.target.files[0];
        if (!file) {
            setImportLogInputErrorMsg("No file selected.");
            return;
        }

        try {
            gActivityList = await readJsonFile(file);
            await updateLogTable(gActivityList);
            setImportLogInputErrorMsg("All good.");
        } catch (error) {
            console.error(error);
            setImportLogInputErrorMsg(error.message);
        }
    }

    async function validateActivity(item) {
        if (typeof item !== "object" || item === null) {
            throw new Error(`Item is not a valid JSON object.`);
        }

        const {date, type, platform, assetType, assetName, currency, amount, unitPrice, totalValue, fee,
            income, convertedFrom, exchangeRate, notes, ...extraFields} = item;

        if (!date) throw new Error("Missing date");
        if (!type) throw new Error("Missing type");
        if (!platform) throw new Error("Missing platform");
        if (!assetType) throw new Error("Missing assetType");
        if (!assetName) throw new Error("Missing assetName");
        if (!currency) throw new Error("Missing currency");
        if (!amount) throw new Error("Missing amount");
        if (!unitPrice) throw new Error("Missing unitPrice");
        if (!totalValue) throw new Error("Missing totalValue");
        if (!fee) throw new Error("Missing fee");
        if (!income) throw new Error("Missing income");
        if (!convertedFrom) throw new Error("Missing convertedFrom");
        if (!exchangeRate) throw new Error("Missing exchangeRate");
        if (!notes) throw new Error("Missing notes");

        if (Object.keys(extraFields).length > 0) {
            throw new Error(`Unhandled fields: ${Object.keys(extraFields).join(", ")}`);
        }

    }

    async function updateLogTable(activityFileJson) {
        if (!Array.isArray(activityFileJson)) {
            throw new Error("Top-level JSON must be an array.");
        }
        const logTable = document.getElementById("logTable");
        logTable.innerHTML = `
        <thead>
        <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Platform</th>
            <th>Asset Type</th>
            <th>Asset Name</th>
            <th>Currency</th>
            <th>Amount</th>
            <th>Unit Price</th>
            <th>Total Value</th>
            <th>Fee</th>
            <th>Income</th>
            <th>Converted From</th>
            <th>Exchange Rate</th>
            <th>Notes</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
        `;

        let errorCount = 0;
        for (const item of activityFileJson) {
            const row = document.createElement("tr");

            try {
                await validateActivity(item); // Await the validation
                row.innerHTML = `
                <td>${item.date}</td>
                <td>${item.type}</td>
                <td>${item.platform}</td>
                <td>${item.assetType}</td>
                <td>${item.assetName}</td>
                <td>${item.currency}</td>
                <td>${item.amount}</td>
                <td>${item.unitPrice}</td>
                <td>${item.totalValue}</td>
                <td>${item.fee}</td>
                <td>${item.income}</td>
                <td>${item.convertedFrom}</td>
                <td>${item.exchangeRate}</td>
                <td>${item.notes}</td>
            `;
            } catch (error) {
                ++errorCount;
                row.innerHTML = `
                <td colspan="14" style="color: red;">Error: ${error.message}</td>
            `;
            }

            logTable.getElementsByTagName("tbody")[0].appendChild(row);
        }

        if (errorCount > 0) throw new Error(`Problems with uploaded document, ${errorCount} errors occurred. See table below.`);
    }

    function onExportLogButtonClick() {
        console.log("onExportLogButtonClick");

        const dataStr = JSON.stringify(gActivityList, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const downloadElement = document.createElement("a");
        downloadElement.href = url;
        downloadElement.download = "portfolio.json";
        document.body.appendChild(downloadElement);
        downloadElement.click();
        document.body.removeChild(downloadElement);
    }
</script>

</body>

</html>
